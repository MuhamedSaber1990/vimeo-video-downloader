<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎥 Vimeo Downloader</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .header h1 {
        margin-bottom: 4px;
        font-size: 28px;
      }
      .header p {
        margin-top: 0;
        color: #666;
      }

      .form-group {
        margin-bottom: 12px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 4px;
      }
      input.form-control {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .btn {
        background-color: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .btn:disabled {
        background-color: #9ec5fe;
        cursor: not-allowed;
      }

      .progress-container {
        display: none;
        margin-top: 16px;
      }
      .progress-text {
        margin-bottom: 6px;
        font-size: 14px;
        color: #333;
      }
      .progress-bar {
        position: relative;
        height: 24px;
        background: #eee;
        border-radius: 12px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        background: #4caf50;
        transition: width 0.2s ease;
      }

      .status-message {
        display: none;
        padding: 8px;
        margin-top: 16px;
        border-radius: 4px;
        font-size: 14px;
      }
      .status-success {
        background: #e0f8e9;
        color: #276738;
      }
      .status-error {
        background: #fde2e1;
        color: #912a2b;
      }
      .status-info {
        background: #e1f0fd;
        color: #1b4f9a;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-top-color: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.6s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .video-info {
        display: none;
        margin-top: 24px;
        border-top: 1px solid #ddd;
        padding-top: 16px;
      }
      .video-info h3 {
        margin-bottom: 8px;
        font-size: 18px;
      }
      .info-item {
        margin-bottom: 6px;
      }
      .info-label {
        font-weight: bold;
        color: #444;
      }
      .info-value {
        margin-left: 6px;
        color: #222;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>🎥 Vimeo Downloader</h1>
      <p>Download private Vimeo videos with ease</p>
    </div>

    <!-- Connect to Google Drive button -->
    <a href="/auth/google/login" class="btn" style="margin-bottom: 16px">
      Connect to Google Drive
    </a>

    <form id="downloadForm">
      <div class="form-group">
        <label for="vimeoUrl">Vimeo Video URL</label>
        <input
          type="url"
          id="vimeoUrl"
          class="form-control"
          placeholder="https://player.vimeo.com/video/123456789"
          required
        />
      </div>

      <div class="form-group">
        <label for="filename">Custom Filename</label>
        <input
          type="text"
          id="filename"
          class="form-control"
          placeholder="my-video"
        />
      </div>

      <button type="submit" class="btn" id="downloadBtn">
        <span id="btnText">Download Video</span>
      </button>
    </form>

    <div class="progress-container" id="progressContainer">
      <div class="progress-text" id="progressText">Preparing download…</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <div class="video-info" id="videoInfo">
      <h3>Video Information</h3>
      <div class="info-item">
        <span class="info-label">Title:</span>
        <span class="info-value" id="videoTitle">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Duration:</span>
        <span class="info-value" id="videoDuration">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Resolution:</span>
        <span class="info-value" id="videoResolution">-</span>
      </div>
      <div class="info-item">
        <span class="info-label">Owner:</span>
        <span class="info-value" id="videoOwner">-</span>
      </div>
    </div>

    <script>
      // ───────────────────────────────────────────────────────────────────────────────
      // 1) On page load, request Notification permission
      // ───────────────────────────────────────────────────────────────────────────────
      document.addEventListener("DOMContentLoaded", () => {
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission();
        }
      });

      // ───────────────────────────────────────────────────────────────────────────────
      // 2) Grab all DOM references
      // ───────────────────────────────────────────────────────────────────────────────
      const form = document.getElementById("downloadForm");
      const downloadBtn = document.getElementById("downloadBtn");
      const btnText = document.getElementById("btnText");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const statusMessage = document.getElementById("statusMessage");
      const videoInfo = document.getElementById("videoInfo");
      const videoTitle = document.getElementById("videoTitle");
      const videoDuration = document.getElementById("videoDuration");
      const videoResolution = document.getElementById("videoResolution");
      const videoOwner = document.getElementById("videoOwner");
      const vimeoUrlInput = document.getElementById("vimeoUrl");
      const filenameInput = document.getElementById("filename");

      // ───────────────────────────────────────────────────────────────────────────────
      // 3) WebSocket logic (dynamic URL + debug logs)
      // ───────────────────────────────────────────────────────────────────────────────
      let ws = null;

      function connectWebSocket() {
        const wsUrl = `ws://${location.host}`;
        console.log("▶️ Attempting WebSocket connection to:", wsUrl);
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log("✅ WebSocket connected.");
        };
        ws.onerror = (err) => {
          console.error("❌ WebSocket error:", err);
        };
        ws.onclose = () => {
          console.warn("⚠️ WebSocket closed. Will retry in 3s…");
          setTimeout(connectWebSocket, 3000);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log("📩 Received via WS:", data);
            handleProgressUpdate(data);
          } catch (e) {
            console.error("⚠️ Could not parse WebSocket message:", e);
          }
        };
      }

      // Immediately attempt to connect on page load
      connectWebSocket();

      // ───────────────────────────────────────────────────────────────────────────────
      // 4) Handle incoming “progress” / “complete” / “error” / “gdrive_upload_complete”
      // ───────────────────────────────────────────────────────────────────────────────
      function handleProgressUpdate(data) {
        switch (data.type) {
          case "progress":
            updateProgress(
              data.percentage,
              data.status,
              data.duration,
              data.size
            );
            if (data.videoTitle) {
              showVideoInfo(
                data.videoTitle,
                data.duration,
                data.resolution,
                data.owner
              );
            }
            break;

          case "complete":
            showStatus("🎉 Download completed successfully!", "success");
            if (
              "Notification" in window &&
              Notification.permission === "granted"
            ) {
              new Notification("Download Complete", {
                body: "Your Vimeo video has finished downloading.",
              });
            }
            resetForm();
            break;

          case "error":
            showStatus("❌ Download failed: " + data.message, "error");
            resetForm();
            break;

          case "gdrive_upload_complete":
            showStatus("✔︎ Uploaded to Google Drive: " + data.file, "success");
            if (
              "Notification" in window &&
              Notification.permission === "granted"
            ) {
              new Notification("Upload Complete", {
                body: `“${data.file}” is now in your Google Drive.`,
              });
            }
            break;

          default:
            console.warn("ℹ️ Unknown message type from WS:", data.type);
        }
      }

      // ───────────────────────────────────────────────────────────────────────────────
      // 5) Update progress bar + text
      // ───────────────────────────────────────────────────────────────────────────────
      function updateProgress(percentage, status, duration, size) {
        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `${status} – ${percentage}% | Duration: ${
          duration || "N/A"
        } | Size: ${size || "N/A"}`;
      }

      // ───────────────────────────────────────────────────────────────────────────────
      // 6) Show video metadata (if server sends it)
      // ───────────────────────────────────────────────────────────────────────────────
      function showVideoInfo(title, duration, resolution, owner) {
        videoTitle.textContent = title || "-";
        videoDuration.textContent = duration || "-";
        videoResolution.textContent = resolution || "-";
        videoOwner.textContent = owner || "-";
        videoInfo.style.display = "block";
      }

      // ───────────────────────────────────────────────────────────────────────────────
      // 7) Show an in-page status message (success / error / info)
      // ───────────────────────────────────────────────────────────────────────────────
      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type}`;
        statusMessage.style.display = "block";
        setTimeout(() => {
          statusMessage.style.display = "none";
        }, 5000);
      }

      // ───────────────────────────────────────────────────────────────────────────────
      // 8) Reset form & progress UI
      // ───────────────────────────────────────────────────────────────────────────────
      function resetForm() {
        downloadBtn.disabled = false;
        btnText.innerHTML = "Download Video";
        progressContainer.style.display = "none";
        progressFill.style.width = "0%";
      }

      // ───────────────────────────────────────────────────────────────────────────────
      // 9) Form submission: POST to /api/download + show “Waiting…” immediately
      // ───────────────────────────────────────────────────────────────────────────────
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const vimeoUrl = vimeoUrlInput.value.trim();
        const filename = filenameInput.value.trim();

        if (!vimeoUrl) {
          showStatus("⚠️ Please enter a valid Vimeo URL", "error");
          return;
        }

        downloadBtn.disabled = true;
        btnText.innerHTML = '<span class="spinner"></span>Starting…';
        progressContainer.style.display = "block";
        progressText.textContent = "⏳ Waiting for progress…";
        statusMessage.style.display = "none";

        try {
          const response = await fetch("/api/download", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vimeoUrl, filename }),
          });
          const result = await response.json();
          if (!response.ok) {
            throw new Error(result.error || "Download initialization failed");
          }
          showStatus("🟢 Download started…", "info");

          // If WebSocket is closed, reconnect
          if (!ws || ws.readyState === WebSocket.CLOSED) {
            connectWebSocket();
          }
        } catch (err) {
          console.error("🔴 Error in /api/download call:", err);
          showStatus("❌ Error: " + err.message, "error");
          resetForm();
        }
      });

      // ───────────────────────────────────────────────────────────────────────────────
      // 10) Auto-fill filename based on Vimeo URL if left blank
      // ───────────────────────────────────────────────────────────────────────────────
      vimeoUrlInput.addEventListener("input", () => {
        const url = vimeoUrlInput.value.trim();
        const match = url.match(/\/(\d+)(?:$|[/?])/);
        if (match && !filenameInput.value) {
          filenameInput.value = `video_${match[1]}`;
        }
      });
    </script>
  </body>
</html>
